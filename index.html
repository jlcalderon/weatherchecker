<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeatherChecker by Jorge Calderon</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/css/bootstrap.min.css" />
    <style>
        * {
            margin: 0px;
            padding: 0px;
        }
        
        header {
            text-align: center;
            background-color: black;
            color: white;
            padding: 2%;
        }
        
        .cities {
            margin-left: 15px;
            padding: 3%;
            background-color: lightgray;
        }
        
        .main {
            padding: 5%;
        }
        
        li {
            border: 2px solid gray;
        }
        
        #weatherInCity {
            border: 2px solid gray;
            padding: 10px;
            margin-left: 30px;
            margin-top: 10px;
            width: 100%;
        }
        
        #fiveDaysForecast {
            padding: 10px;
            margin-left: 30px;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-12 col-md-12">
                <header>
                    <h1>Weather Checker</h1>
                </header>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-4 col-md-3 cities">
                <aside>
                    <form>
                        <div class="form-group">
                            <label for="city-txt">City: </label>
                            <input type="text" class="form-control" id="city-txt" aria-describedby="citylHelp">
                            <small id="citylHelp" class="form-text text-muted">Enter city to look up for weather conditions.</small>
                        </div>
                        <div class="form-group">
                            <button id="city-submit" type="submit">Submit</button>
                        </div>
                    </form>
                    <ul class="list-group">
                    </ul>
                </aside>
            </div>
            <div calss="col-sm-8 col-md-9 main">
                <div class="row">
                    <div class="col-sm-12 col-md-12">
                        <div id="weatherInCity" style="display: none;">

                        </div>
                        <!-- <h1>Uno</h1> -->
                    </div>
                </div>
                <div class="row">
                    <div id="fiveDaysForecast" class="col-sm-12 col-md-12">
                        <!-- <h1>Dos</h1> -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript">
    let responsesArray = [];
    let responsesString = localStorage.getItem("weatherResponses");
    renderList();
    //This ready function grab the localstorage varaibles of current responses
    //and fill the array to render the app with persistent information
    //let responsesString = localStorage.getItem("weatherResponses");
    //submit form function to make an API weather call by city 


    function renderList() {
        $('<ul>').html("");
        if (responsesString) {
            responsesArray = responsesString.split('///');
        } else {
            responsesString = " ";
        }
        //console.log(responsesArray);
        for (let i = 0; i < responsesArray.length - 1; i++) {
            console.log(JSON.parse(responsesArray[i]));
            let cityEl = $("<li>");
            cityEl.text(JSON.parse(responsesArray[i]).name);
            cityEl.addClass("list-group-item");
            cityEl.addClass("citiesLi");
            cityEl.attr("data-name", JSON.parse(responsesArray[i]).name);
            cityEl.attr("data-lon", JSON.parse(responsesArray[i]).coord.lon);
            cityEl.attr("data-lat", JSON.parse(responsesArray[i]).coord.lat);
            $("ul").append(cityEl);
        }
    }

    //Form submission
    $("form").on("submit", function(e) {
        e.preventDefault();
        const city = $('#city-txt').val();
        //my API key
        var APIKey = "4ebb8d7264ca67547a6a7bdbe2deada9";
        //url to make the queries for this API
        var url = `http://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${APIKey}`;
        // Asyncronous javascript request usuing ajax
        $.ajax({
            url: url,
            method: "GET"
        }).then(function(response) {
            //Grabing response from API and printing to console
            console.log(response);
            //Grabing response and storing in a localStorage variable
            if (responsesString !== " ") {
                responsesString = responsesString + JSON.stringify(response) + '///';
            } else {
                responsesString = JSON.stringify(response) + '///';
            }

            localStorage.setItem("weatherResponses", responsesString);
            //Creating and adding a <li> element to the <ul> list-group 

            let cityEl = $("<li>");
            cityEl.text(response.name);
            cityEl.addClass("list-group-item");
            cityEl.addClass("citiesLi");
            cityEl.attr("data-name", response.name);
            cityEl.attr("data-lon", response.coord.lon);
            cityEl.attr("data-lat", response.coord.lat);
            $("ul").append(cityEl);
            $('#city-txt').val("");
            location.reload();
        });
        $("<ul>").html("");
    });

    //Grabing click event from city clicked
    $(document).on("click", ".citiesLi", function() {
        var city = $(this).attr("data-name");
        const _dataContainer = $('#weatherInCity');
        _dataContainer.html("");
        const selectedCity = getCityWeather(city);
        //console.log(selectedCity[0].name);
        const _dataCity = $("<h1>");
        let curday = moment().format('MM/DD/YY');
        _dataCity.text(selectedCity[0].name + " " + curday + " " + selectedCity[0].weather[0].icon);
        _dataContainer.append(_dataCity);

        const _dataTemp = $("<p>");
        //var tempF = (response.main.temp - 273.15) * 1.80 + 32;
        _dataTemp.text("Temperature in F: " + ((selectedCity[0].main.temp - 273.15) * 1.80 + 32).toFixed(2));
        _dataContainer.append(_dataTemp);

        const _dataHumidity = $("<p>");
        _dataHumidity.text("Humidity: " + selectedCity[0].main.humidity + "%");
        _dataContainer.append(_dataHumidity);

        const _dataWindSpeed = $("<p>");
        _dataWindSpeed.text("Wind Speed: " + selectedCity[0].wind.speed);
        _dataContainer.append(_dataWindSpeed);

        const _dataUVI = $("<p>");
        _dataUVI.text("UV Index: " + selectedCity[0]);
        _dataContainer.append(_dataUVI);
        _dataContainer.attr("style", "display:block;");
    });

    function getCityWeather(_city) {
        let tempArray = [];
        for (let j = 0; j < responsesArray.length - 1; j++) {
            tempArray.push(JSON.parse(responsesArray[j]));
        }
        return tempArray.filter((w) => w.name === _city);
    }
</script>

</html>